<!--
SERENDIPITY BASE TEMPLATE
=========================

This template is fully customizable by the user.
Edit this file to change the HTML structure and default styling.

REQUIRED ELEMENTS (JavaScript depends on these):
- Element with id="convergent-list" to hold convergent recommendations
- Element with id="divergent-list" to hold divergent recommendations
- Loading indicators with id="convergent-loading" and id="divergent-loading"
- Buttons with onclick="requestMore('convergent')" and onclick="requestMore('divergent')"

PLACEHOLDERS (automatically replaced by Python):
- {css} - Custom CSS generated by Claude
- {convergent_html} - Convergent recommendation cards
- {divergent_html} - Divergent recommendation cards
- {session_id} - The current session ID
- {server_port} - The feedback server port
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serendipity - Discoveries</title>
    <style>
{css}

/* Context Panel Styles */
.context-panel {
    position: fixed;
    left: 0;
    top: 0;
    height: 100vh;
    width: 320px;
    background: #1a1a2e;
    border-right: 1px solid #333;
    z-index: 1000;
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
    font-size: 13px;
}

.context-panel.collapsed {
    transform: translateX(-280px);
}

.toggle-panel {
    position: absolute;
    right: -40px;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 80px;
    background: #1a1a2e;
    border: 1px solid #333;
    border-left: none;
    border-radius: 0 8px 8px 0;
    color: #888;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.toggle-panel:hover {
    background: #252540;
    color: #fff;
}

.panel-header {
    padding: 16px;
    border-bottom: 1px solid #333;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.panel-section {
    border-bottom: 1px solid #333;
}

.section-header {
    padding: 12px 16px;
    background: #252540;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #aaa;
    font-weight: 500;
}

.section-header:hover {
    background: #2a2a4a;
    color: #fff;
}

.section-header .arrow {
    transition: transform 0.2s;
}

.section-header.expanded .arrow {
    transform: rotate(90deg);
}

.section-content {
    padding: 12px 16px;
    display: none;
    color: #ccc;
    max-height: 300px;
    overflow-y: auto;
}

.section-content.visible {
    display: block;
}

.section-content pre {
    white-space: pre-wrap;
    word-break: break-word;
    font-family: inherit;
    margin: 0;
    font-size: 12px;
    line-height: 1.5;
}

.history-item {
    padding: 8px 0;
    border-bottom: 1px solid #333;
}

.history-item:last-child {
    border-bottom: none;
}

.history-item .url {
    color: #d4918a;  /* Muted Rose */
    font-size: 11px;
    word-break: break-all;
    display: block;
    margin-bottom: 4px;
}

.history-item .feedback {
    font-size: 11px;
    color: #888;
}

.history-item .feedback.liked { color: #4caf50; }
.history-item .feedback.disliked { color: #f44336; }

.user-input-display {
    font-style: italic;
    color: #aaa;
    line-height: 1.6;
}

.summary-text {
    color: #8bc34a;
    font-style: italic;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px dashed #444;
}

.no-content {
    color: #666;
    font-style: italic;
}

/* Session Stats */
.session-stats {
    padding: 12px 16px;
    background: #1e1e32;
    border-bottom: 1px solid #333;
    display: flex;
    gap: 16px;
    font-size: 12px;
}

.stat {
    display: flex;
    align-items: center;
    gap: 4px;
}

.stat-liked { color: #4caf50; }
.stat-disliked { color: #f44336; }
.stat-total { color: #888; }

/* Adjust main content when panel is visible */
body.panel-expanded {
    margin-left: 320px;
    transition: margin-left 0.3s ease;
}
    </style>
</head>
<body class="panel-expanded">
    <!-- Context Panel -->
    <div id="context-panel" class="context-panel">
        <button class="toggle-panel" onclick="togglePanel()" title="Toggle context panel">‚óÄ</button>

        <div class="panel-header">
            <span>üìã</span>
            <span>Context</span>
        </div>

        <div class="session-stats">
            <div class="stat stat-total">Shown: <span id="stat-shown">0</span></div>
            <div class="stat stat-liked">üëç <span id="stat-liked">0</span></div>
            <div class="stat stat-disliked">üëé <span id="stat-disliked">0</span></div>
        </div>

        <div class="panel-content">
            <!-- Rules Section -->
            <div class="panel-section">
                <div class="section-header expanded" onclick="toggleSection(this)">
                    <span>üìú Rules</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="section-content visible" id="rules-content">
                    <span class="no-content">Loading...</span>
                </div>
            </div>

            <!-- History Section -->
            <div class="panel-section">
                <div class="section-header expanded" onclick="toggleSection(this)">
                    <span>üïê History</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="section-content visible" id="history-content">
                    <div id="history-summary"></div>
                    <div id="history-items"></div>
                </div>
            </div>

            <!-- User Input Section -->
            <div class="panel-section">
                <div class="section-header expanded" onclick="toggleSection(this)">
                    <span>üí≠ Your Input</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="section-content visible" id="input-content">
                    <span class="no-content">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="header">
        <h1>Your Discoveries</h1>
    </div>

    <div class="more-actions">
        <button onclick="requestMore('convergent')">More like this</button>
        <button onclick="requestMore('divergent')">More surprises</button>
    </div>

    <div class="container">
        <div class="column convergent">
            <h2>More Like This</h2>
            <div id="convergent-list">
{convergent_html}
            </div>
            <div class="loading" id="convergent-loading">Loading more...</div>
        </div>
        <div class="column divergent">
            <h2>Expand Your Palette</h2>
            <div id="divergent-list">
{divergent_html}
            </div>
            <div class="loading" id="divergent-loading">Loading more...</div>
        </div>
    </div>

    <!-- DO NOT MODIFY THIS SCRIPT BLOCK - handles feedback, context panel, and "more" requests -->
    <script>
        const SESSION_ID = "{session_id}";
        const SERVER_PORT = {server_port};
        const API_BASE = window.location.hostname === 'localhost' ? '' : `http://localhost:${SERVER_PORT}`;

        // Track session feedback for live feedback loop
        const sessionFeedback = [];

        // Stats tracking
        let statsShown = 0;
        let statsLiked = 0;
        let statsDisliked = 0;

        // Initialize: count initial recommendations and load context
        document.addEventListener('DOMContentLoaded', () => {
            // Count initial recommendations
            statsShown = document.querySelectorAll('.recommendation').length;
            updateStats();

            // Load context panel data
            loadContext();
        });

        function updateStats() {
            document.getElementById('stat-shown').textContent = statsShown;
            document.getElementById('stat-liked').textContent = statsLiked;
            document.getElementById('stat-disliked').textContent = statsDisliked;
        }

        function togglePanel() {
            const panel = document.getElementById('context-panel');
            const btn = panel.querySelector('.toggle-panel');
            panel.classList.toggle('collapsed');
            document.body.classList.toggle('panel-expanded');
            btn.textContent = panel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
        }

        function toggleSection(header) {
            header.classList.toggle('expanded');
            const content = header.nextElementSibling;
            content.classList.toggle('visible');
        }

        async function loadContext() {
            try {
                const response = await fetch(`${API_BASE}/context?session_id=${SESSION_ID}`);
                if (!response.ok) return;

                const data = await response.json();

                // Populate rules
                const rulesEl = document.getElementById('rules-content');
                if (data.rules && data.rules.trim()) {
                    rulesEl.innerHTML = `<pre>${escapeHtml(data.rules)}</pre>`;
                } else {
                    rulesEl.innerHTML = '<span class="no-content">No rules defined yet</span>';
                }

                // Populate history
                const summaryEl = document.getElementById('history-summary');
                const itemsEl = document.getElementById('history-items');

                if (data.history_summary && data.history_summary.trim()) {
                    summaryEl.innerHTML = `<div class="summary-text">${escapeHtml(data.history_summary)}</div>`;
                }

                if (data.history && data.history.length > 0) {
                    itemsEl.innerHTML = data.history.slice(-10).reverse().map(item => `
                        <div class="history-item">
                            <span class="url">${escapeHtml(item.url)}</span>
                            <span class="feedback ${item.feedback || ''}">${
                                item.feedback === 'liked' ? 'üëç liked' :
                                item.feedback === 'disliked' ? 'üëé disliked' :
                                '‚Äî no feedback'
                            }</span>
                        </div>
                    `).join('');
                } else {
                    itemsEl.innerHTML = '<span class="no-content">No history yet</span>';
                }

                // Populate user input
                const inputEl = document.getElementById('input-content');
                if (data.user_input && data.user_input.trim()) {
                    inputEl.innerHTML = `<div class="user-input-display">${escapeHtml(data.user_input)}</div>`;
                } else {
                    inputEl.innerHTML = '<span class="no-content">No input recorded</span>';
                }
            } catch (e) {
                console.error('Failed to load context:', e);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function feedback(button, rating) {
            const rec = button.closest('.recommendation');
            const url = rec.dataset.url;

            try {
                const response = await fetch(`${API_BASE}/feedback`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        url: url,
                        session_id: SESSION_ID,
                        feedback: rating
                    })
                });

                if (response.ok) {
                    const buttons = rec.querySelectorAll('.actions button');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.classList.remove('liked', 'disliked');
                    });
                    button.classList.add(rating);

                    // Track feedback for live feedback loop
                    // Remove any existing feedback for this URL
                    const existingIdx = sessionFeedback.findIndex(f => f.url === url);
                    if (existingIdx >= 0) {
                        const oldFeedback = sessionFeedback[existingIdx].feedback;
                        if (oldFeedback === 'liked') statsLiked--;
                        else if (oldFeedback === 'disliked') statsDisliked--;
                        sessionFeedback.splice(existingIdx, 1);
                    }

                    sessionFeedback.push({ url, feedback: rating });

                    // Update stats
                    if (rating === 'liked') statsLiked++;
                    else if (rating === 'disliked') statsDisliked++;
                    updateStats();
                }
            } catch (e) {
                console.error('Feedback error:', e);
                alert('Could not save feedback. Is the serendipity server still running?');
            }
        }

        async function requestMore(type) {
            const loading = document.getElementById(`${type}-loading`);
            const list = document.getElementById(`${type}-list`);
            const btn = document.querySelector(`button[onclick="requestMore('${type}')"]`);

            if (btn) btn.disabled = true;
            loading.classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/more`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: SESSION_ID,
                        type: type,
                        count: 5,
                        session_feedback: sessionFeedback  // Include live feedback
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.recommendations && data.recommendations.length > 0) {
                        data.recommendations.forEach(rec => {
                            const div = document.createElement('div');
                            div.className = 'recommendation';
                            div.dataset.url = rec.url;
                            div.innerHTML = `
                                <a href="${rec.url}" target="_blank" rel="noopener">${rec.url}</a>
                                <p class="reason">${rec.reason}</p>
                                <div class="actions">
                                    <button onclick="feedback(this, 'liked')">üëç</button>
                                    <button onclick="feedback(this, 'disliked')">üëé</button>
                                </div>
                            `;
                            list.appendChild(div);
                            statsShown++;
                        });
                        updateStats();
                    }
                } else {
                    const error = await response.json();
                    console.error('More error:', error);
                    alert('Could not get more recommendations: ' + (error.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Request more error:', e);
                alert('Could not get more recommendations. Is the serendipity server still running?');
            } finally {
                if (btn) btn.disabled = false;
                loading.classList.remove('active');
            }
        }
    </script>
</body>
</html>
