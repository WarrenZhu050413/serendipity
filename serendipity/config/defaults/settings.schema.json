{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/serendipity/settings.schema.json",
  "title": "Serendipity Settings",
  "description": "Single source of truth for all serendipity configuration",
  "type": "object",
  "properties": {
    "version": {
      "type": "integer",
      "description": "Configuration schema version",
      "default": 2
    },
    "model": {
      "type": "string",
      "enum": ["opus", "sonnet", "haiku"],
      "description": "Default Claude model to use",
      "default": "opus"
    },
    "total_count": {
      "type": "integer",
      "description": "Total number of recommendations per discovery",
      "default": 10
    },
    "feedback_server_port": {
      "type": "integer",
      "description": "Port for the HTML feedback server",
      "default": 9876
    },
    "approaches": {
      "type": "object",
      "description": "How to find recommendations",
      "additionalProperties": {
        "$ref": "#/definitions/ApproachType"
      }
    },
    "media": {
      "type": "object",
      "description": "What format of content to recommend",
      "additionalProperties": {
        "$ref": "#/definitions/MediaType"
      }
    },
    "context_sources": {
      "type": "object",
      "description": "Sources of user context/profile information",
      "additionalProperties": {
        "$ref": "#/definitions/ContextSource"
      }
    },
    "thinking_tokens": {
      "type": ["integer", "null"],
      "description": "Extended thinking budget (null=disabled)",
      "default": 1024
    },
    "pairings_enabled": {
      "type": "boolean",
      "description": "Whether to include contextual pairings",
      "default": true
    },
    "pairings": {
      "type": "object",
      "description": "Contextual bonus content (music, food, etc.)",
      "additionalProperties": {
        "$ref": "#/definitions/PairingType"
      }
    },
    "output": {
      "type": "object",
      "description": "Output format and destination settings",
      "properties": {
        "default_format": {
          "type": "string",
          "enum": ["json", "markdown", "html"],
          "default": "html"
        },
        "default_destination": {
          "type": "string",
          "enum": ["browser", "stdout", "file", "gmail", "slack"],
          "default": "browser"
        },
        "destinations": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/OutputDestination"
          }
        }
      }
    }
  },
  "definitions": {
    "ApproachType": {
      "type": "object",
      "properties": {
        "display_name": {
          "type": "string",
          "description": "Human-readable name"
        },
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "prompt_hint": {
          "type": "string",
          "description": "Instructions for Claude about this approach"
        }
      },
      "required": ["display_name"]
    },
    "MediaType": {
      "type": "object",
      "properties": {
        "display_name": {
          "type": "string"
        },
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "sources": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Source"
          }
        },
        "prompt_hint": {
          "type": "string"
        },
        "preference": {
          "type": "string",
          "description": "Optional natural language hint about user's preference for this media type"
        },
        "metadata_schema": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/MetadataField"
          }
        }
      },
      "required": ["display_name"]
    },
    "Source": {
      "type": "object",
      "properties": {
        "tool": {
          "type": "string",
          "description": "Tool name (WebSearch, WebFetch, or mcp__server__tool)"
        },
        "hints": {
          "type": "string",
          "description": "Search hints with {query} placeholder"
        }
      },
      "required": ["tool"]
    },
    "MetadataField": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "required": {
          "type": "boolean",
          "default": false
        }
      },
      "required": ["name"]
    },
    "ContextSource": {
      "type": "object",
      "oneOf": [
        { "$ref": "#/definitions/LoaderSource" },
        { "$ref": "#/definitions/MCPSource" }
      ]
    },
    "LoaderSource": {
      "type": "object",
      "properties": {
        "type": {
          "const": "loader"
        },
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "description": {
          "type": "string"
        },
        "loader": {
          "type": "string",
          "description": "Python module path to loader function",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*(\\.[a-zA-Z_][a-zA-Z0-9_]*)*$"
        },
        "prompt_hint": {
          "type": "string",
          "description": "Template with {content} placeholder"
        },
        "options": {
          "type": "object",
          "description": "Options passed to the loader function"
        }
      },
      "required": ["type", "loader"]
    },
    "MCPSource": {
      "type": "object",
      "properties": {
        "type": {
          "const": "mcp"
        },
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "description": {
          "type": "string"
        },
        "server": {
          "type": "object",
          "properties": {
            "url": {
              "type": "string",
              "description": "MCP server URL (can use {port} placeholder)"
            },
            "type": {
              "type": "string",
              "enum": ["http", "stdio"]
            },
            "headers": {
              "type": "object",
              "additionalProperties": { "type": "string" }
            }
          },
          "required": ["url", "type"]
        },
        "health_check": {
          "type": "object",
          "properties": {
            "endpoint": { "type": "string" },
            "timeout": { "type": "number" }
          }
        },
        "setup": {
          "type": "object",
          "properties": {
            "cli_command": { "type": "string" },
            "install_hint": { "type": "string" },
            "home_dir": { "type": "string" },
            "docs_dir": { "type": "string" }
          }
        },
        "port": {
          "type": "object",
          "properties": {
            "default": { "type": "integer" },
            "max_retries": { "type": "integer" }
          }
        },
        "auto_start": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "command": {
              "type": "array",
              "items": { "type": "string" }
            },
            "log_path": { "type": "string" }
          }
        },
        "tools": {
          "type": "object",
          "properties": {
            "allowed": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        },
        "prompt_hint": {
          "type": "string",
          "description": "Instructions for Claude about using this MCP server"
        }
      },
      "required": ["type", "server"]
    },
    "PairingType": {
      "type": "object",
      "properties": {
        "display_name": {
          "type": "string",
          "description": "Human-readable name shown in UI"
        },
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "search_based": {
          "type": "boolean",
          "description": "If true, uses WebSearch to find real links",
          "default": false
        },
        "icon": {
          "type": "string",
          "description": "Icon for the pairing. Can be an emoji (ðŸŽµ), Lucide icon name (music), or SVG path (icons/music.svg)"
        },
        "max_count": {
          "type": "integer",
          "description": "Maximum number of this pairing type"
        },
        "prompt_hint": {
          "type": "string",
          "description": "Instructions for Claude about this pairing"
        }
      },
      "required": ["display_name"]
    },
    "OutputDestination": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["builtin", "command", "webhook"]
        },
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "description": {
          "type": "string"
        },
        "command": {
          "type": "string",
          "description": "Shell command for 'command' type destinations"
        },
        "webhook_url": {
          "type": "string",
          "description": "URL for 'webhook' type destinations"
        },
        "format": {
          "type": "string",
          "description": "Override output format for this destination"
        },
        "options": {
          "type": "object",
          "description": "Destination-specific options"
        }
      },
      "required": ["type"]
    }
  }
}
